<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>ØªØ·Ø¨ÙŠÙ‚ Ù…ØµØºØ±</title>
  <style>
    body {
      margin: 0; padding: 20px;
      font-family: Arial, sans-serif;
      text-align: center;
    }
    /* Ø­Ø§ÙˆÙŠØ© Ø£Ø²Ø±Ø§Ø± Home Ùˆ Leaderboard Ùˆ Admin */
    #btns {
      position: fixed; bottom: 20px; right: 20px;
      display: flex; gap: 10px;
    }
    #btns button {
      padding: 8px 12px; font-size: 14px; cursor: pointer;
      display: flex; flex-direction: column; align-items: center;
      border: 1px solid #333; border-radius: 4px; background: #fff;
    }
    /* Ø²Ø± Home ÙŠØ­ØªÙˆÙŠ Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ù„Ø§Ø³Ù… */
    #home-btn img {
      width: 40px; height: 40px;
      border-radius: 50%; object-fit: cover;
      margin-bottom: 4px;
    }
    /* Ù‚Ø³Ù… Ø§Ù„Ø¥Ø­Ø§Ù„Ø© */
    #ref-section {
      margin-top: 100px;
      font-size: 16px;
    }
    #ref-section input {
      width: 80%; padding: 6px;
      text-align: center;
      margin: 6px 0 12px;
    }
    /* Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù…Ø®ÙÙŠØªØ§Ù† Ø¨Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© */
    #leaderboard, #admin-panel {
      display: none; margin-top: 30px; text-align: left;
    }
    #leaderboard div, #admin-panel div {
      margin-bottom: 8px;
    }
    #leaderboard img, #admin-panel img {
      width: 24px; height: 24px; border-radius: 50%; vertical-align: middle;
      margin-left: 6px;
    }
  </style>
</head>
<body>

  <!-- Ù‚Ø³Ù… Ø§Ù„Ø¥Ø­Ø§Ù„Ø© -->
  <div id="ref-section">
    <div>Your Link</div>
    <input type="text" id="ref-link" readonly/>
    <div>Invited</div>
    <div id="invited-count">0</div>
  </div>

  <!-- Ø£Ø²Ø±Ø§Ø± Home / Leaderboard / Admin -->
  <div id="btns">
    <button id="home-btn">
      <img id="btn-user-photo" src="" alt="ØµÙˆØ±Ø©">
      <span id="btn-user-name">User</span>
      <span>Home</span>
    </button>
    <button id="leaderboard-btn">Leaderboard</button>
    <button id="admin-btn" style="display:none;">Admin</button>
  </div>

  <!-- Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© -->
  <div id="leaderboard"><h3>ğŸ† Leaderboard</h3></div>
  <div id="admin-panel"><h3>ğŸ”§ Admin Panel</h3></div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    const user = tg.initDataUnsafe.user;
    const urlParams = new URLSearchParams(window.location.search);
    const refCodeIn = urlParams.get('ref') || null;

    // 1) Ø·Ù„Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ø¥Ø­Ø§Ù„Ø©
    fetch('/api/user', {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ user, refCode: refCodeIn })
    })
    .then(r => r.json())
    .then(data => {
      // Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø©
      const link = `${window.location.origin}?ref=${data.referralCode}`;
      document.getElementById('ref-link').value = link;
      document.getElementById('invited-count').textContent = data.invitedCount;
    });

    // 2) Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØµÙˆØ±ØªÙ‡ ÙÙŠ Ø²Ø± Home
    document.getElementById('btn-user-photo').src = user.photo_url;
    const name = user.first_name + (user.last_name ? ' ' + user.last_name : '');
    document.getElementById('btn-user-name').textContent = name;

    // 3) Ø²Ø± Home ÙŠÙØ¹ÙŠØ¯ ØªÙˆØ¬ÙŠÙ‡ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    document.getElementById('home-btn').onclick = () => {
      window.location.href = '/home';
    };

    // 4) Ø²Ø± Leaderboard
    document.getElementById('leaderboard-btn').onclick = () => {
      fetch('/api/leaderboard')
        .then(r => r.json())
        .then(list => {
          const lb = document.getElementById('leaderboard');
          lb.innerHTML = '<h3>ğŸ† Leaderboard</h3>' +
            list.map((u,i) => `
              <div>${i+1}. ${u.first_name} ${u.last_name||''}
                <img src="${u.photo_url}" alt="">
                (${u.invited_count})
              </div>
            `).join('');
          lb.style.display = 'block';
        });
    };

    // 5) Ø²Ø± Admin Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ahmed1999101 ÙÙ‚Ø·
    if (user.username === 'ahmed1999101') {
      const btn = document.getElementById('admin-btn');
      btn.style.display = 'flex';
      btn.onclick = () => {
        fetch('/api/admin/users', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ user })
        })
        .then(r => r.json())
        .then(all => {
          const panel = document.getElementById('admin-panel');
          panel.innerHTML = '<h3>ğŸ”§ Admin Panel</h3>' +
            all.map((u,i) => `
              <div>${i+1}. ${u.first_name} ${u.last_name||''}
                <img src="${u.photo_url}" alt="">
                ${u.phone || ''}
              </div>
            `).join('');
          panel.style.display = 'block';
        });
      };
    }
  </script>
</body>
</html>
