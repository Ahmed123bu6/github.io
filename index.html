<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>تطبيق مصغر</title>
  <style>
    body {
      margin: 0; padding: 20px;
      font-family: Arial, sans-serif;
      text-align: center;
    }
    /* حاوية أزرار Home و Leaderboard و Admin */
    #btns {
      position: fixed; bottom: 20px; right: 20px;
      display: flex; gap: 10px;
    }
    #btns button {
      padding: 8px 12px; font-size: 14px; cursor: pointer;
      display: flex; flex-direction: column; align-items: center;
      border: 1px solid #333; border-radius: 4px; background: #fff;
    }
    /* زر Home يحتوي الصورة والاسم */
    #home-btn img {
      width: 40px; height: 40px;
      border-radius: 50%; object-fit: cover;
      margin-bottom: 4px;
    }
    /* قسم الإحالة */
    #ref-section {
      margin-top: 100px;
      font-size: 16px;
    }
    #ref-section input {
      width: 80%; padding: 6px;
      text-align: center;
      margin: 6px 0 12px;
    }
    /* لوحة المتصدرين والإدارة مخفيتان بالبداية */
    #leaderboard, #admin-panel {
      display: none; margin-top: 30px; text-align: left;
    }
    #leaderboard div, #admin-panel div {
      margin-bottom: 8px;
    }
    #leaderboard img, #admin-panel img {
      width: 24px; height: 24px; border-radius: 50%; vertical-align: middle;
      margin-left: 6px;
    }
  </style>
</head>
<body>

  <!-- قسم الإحالة -->
  <div id="ref-section">
    <div>Your Link</div>
    <input type="text" id="ref-link" readonly/>
    <div>Invited</div>
    <div id="invited-count">0</div>
  </div>

  <!-- أزرار Home / Leaderboard / Admin -->
  <div id="btns">
    <button id="home-btn">
      <img id="btn-user-photo" src="" alt="صورة">
      <span id="btn-user-name">User</span>
      <span>Home</span>
    </button>
    <button id="leaderboard-btn">Leaderboard</button>
    <button id="admin-btn" style="display:none;">Admin</button>
  </div>

  <!-- قوائم الديناميكية -->
  <div id="leaderboard"><h3>🏆 Leaderboard</h3></div>
  <div id="admin-panel"><h3>🔧 Admin Panel</h3></div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // بيانات المستخدم
    const user = tg.initDataUnsafe.user;
    const urlParams = new URLSearchParams(window.location.search);
    const refCodeIn = urlParams.get('ref') || null;

    // 1) طلب تسجيل المستخدم والإحالة
    fetch('/api/user', {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ user, refCode: refCodeIn })
    })
    .then(r => r.json())
    .then(data => {
      // رابط الإحالة
      const link = `${window.location.origin}?ref=${data.referralCode}`;
      document.getElementById('ref-link').value = link;
      document.getElementById('invited-count').textContent = data.invitedCount;
    });

    // 2) عرض اسم المستخدم وصورته في زر Home
    document.getElementById('btn-user-photo').src = user.photo_url;
    const name = user.first_name + (user.last_name ? ' ' + user.last_name : '');
    document.getElementById('btn-user-name').textContent = name;

    // 3) زر Home يُعيد توجيه للصفحة الرئيسية
    document.getElementById('home-btn').onclick = () => {
      window.location.href = '/home';
    };

    // 4) زر Leaderboard
    document.getElementById('leaderboard-btn').onclick = () => {
      fetch('/api/leaderboard')
        .then(r => r.json())
        .then(list => {
          const lb = document.getElementById('leaderboard');
          lb.innerHTML = '<h3>🏆 Leaderboard</h3>' +
            list.map((u,i) => `
              <div>${i+1}. ${u.first_name} ${u.last_name||''}
                <img src="${u.photo_url}" alt="">
                (${u.invited_count})
              </div>
            `).join('');
          lb.style.display = 'block';
        });
    };

    // 5) زر Admin للمستخدم ahmed1999101 فقط
    if (user.username === 'ahmed1999101') {
      const btn = document.getElementById('admin-btn');
      btn.style.display = 'flex';
      btn.onclick = () => {
        fetch('/api/admin/users', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ user })
        })
        .then(r => r.json())
        .then(all => {
          const panel = document.getElementById('admin-panel');
          panel.innerHTML = '<h3>🔧 Admin Panel</h3>' +
            all.map((u,i) => `
              <div>${i+1}. ${u.first_name} ${u.last_name||''}
                <img src="${u.photo_url}" alt="">
                ${u.phone || ''}
              </div>
            `).join('');
          panel.style.display = 'block';
        });
      };
    }
  </script>
</body>
</html>
